<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HL7 Viewer</title>
  <link rel="icon" type="image/png" href="HL7Favicon.png">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/viewer.css">
</head>
<body>
  <div class="app-container">
    <!-- Top Menu Bar -->
    <header class="menu-bar">
      <div class="menu-left">
        <h1 class="app-title">HL7 Viewer</h1>
        <div class="control-group page-toggle-group">
          <label class="control-label">Page:</label>
          <div class="view-toggle">
            <label class="toggle-option">
              <input type="radio" name="pageMode" value="viewer" checked>
              <span class="toggle-btn">Viewer</span>
            </label>
            <label class="toggle-option">
              <input type="radio" name="pageMode" value="statistics">
              <span class="toggle-btn">Statistics</span>
            </label>
          </div>
        </div>
        <button id="downloadLocalBtn" class="download-local-btn">Download Local Application</button>
        <a href="mailto:zach@zachromers.com" class="contact-me-btn">Contact Me</a>
        <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank" rel="noopener" class="contact-me-btn">Submit Feedback</a>
      </div>
      <div class="menu-controls">
        <div class="control-group viewer-only-control">
          <label class="control-label">View Mode:</label>
          <div class="view-toggle">
            <label class="toggle-option">
              <input type="radio" name="viewMode" value="collapsed" checked>
              <span class="toggle-btn">Tree View</span>
            </label>
            <label class="toggle-option">
              <input type="radio" name="viewMode" value="standard">
              <span class="toggle-btn">Textual View</span>
            </label>
          </div>
        </div>
        <div class="control-group viewer-only-control">
          <label class="checkbox-control">
            <input type="checkbox" id="hideEmptyFields">
            <span class="checkbox-label">Hide Empty Fields</span>
          </label>
        </div>
        <div class="control-group viewer-only-control">
          <label class="control-label" for="messagesPerBatch">Batch Size:</label>
          <select id="messagesPerBatch" class="select-control">
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <button id="clearBtn" class="clear-btn" title="Clear viewer">Clear</button>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Input Area -->
      <div class="input-area" id="inputArea">
        <div class="drop-zone" id="dropZone">
          <div class="drop-zone-content">
            <div class="drop-icon">&#128196;</div>
            <p class="drop-text">Drag & drop HL7 or JSON files here</p>
            <p class="drop-subtext">or</p>
            <label class="file-input-label">
              <input type="file" id="fileInput" accept=".hl7,.json,.txt" multiple>
              <span class="browse-btn">Browse Files</span>
            </label>
          </div>
        </div>

        <div class="text-input-area">
          <textarea id="textInput" placeholder="Or paste HL7/JSON content here..."></textarea>
          <button id="loadBtn" class="load-btn">Load Content</button>
        </div>
      </div>

      <!-- Viewer Area -->
      <div class="viewer-area" id="viewerArea">
        <div class="hl7-container" id="viewerContainer">
          <div class="welcome-message">
            <p>Upload a file or paste content to view HL7/JSON data</p>
          </div>
        </div>
      </div>

      <!-- Statistics Panel -->
      <div class="stats-panel" id="statsPanel">
        <div class="stats-no-data-message" id="statsNoDataMessage">
          <p>No HL7 content loaded</p>
          <p class="stats-hint">Switch to Viewer page to load HL7 data first</p>
        </div>
        <div class="stats-input-section" id="statsInputSection">
          <div class="stats-input-header">
            <h2>Field Statistics</h2>
            <p>Enter an HL7 field reference to generate statistics. Optionally filter messages first.</p>
          </div>
          <div class="stats-input-form">
            <div class="stats-filters-section">
              <div class="stats-filters-header">
                <label>
                  Filters (optional):
                  <span class="stats-info-icon" id="filterInfoIcon">&#9432;
                    <div class="stats-info-popup">
                      <h4>Filter Syntax</h4>
                      <p>Filter messages before generating statistics using the format:<br><code>FIELD OPERATOR VALUE</code></p>
                      <h4>Operators</h4>
                      <table class="stats-info-table">
                        <tr><td><code>=</code></td><td>Equals (exact match)</td><td><code>PV1.2 = E</code></td></tr>
                        <tr><td><code>!=</code></td><td>Not equals</td><td><code>PV1.2 != I</code></td></tr>
                        <tr><td><code>contains</code></td><td>Contains substring</td><td><code>PV1.3 contains ER</code></td></tr>
                        <tr><td><code>!contains</code></td><td>Does not contain</td><td><code>PV1.3 !contains ICU</code></td></tr>
                      </table>
                      <h4>Field Format</h4>
                      <p>Use standard HL7 notation:</p>
                      <ul>
                        <li><code>PV1.2</code> - Segment.Field</li>
                        <li><code>PID.5.1</code> - Segment.Field.Component</li>
                        <li><code>PID.3.4.1</code> - Segment.Field.Component.Subcomponent</li>
                      </ul>
                      <p class="stats-info-note">Comparisons are case-insensitive.</p>
                    </div>
                  </span>
                </label>
              </div>
              <div class="stats-filters-list" id="statsFiltersList">
                <div class="stats-filter-row" data-filter-id="1">
                  <span class="stats-filter-label">F1</span>
                  <input type="text" class="stats-field-input stats-filter-input" placeholder="e.g., PV1.2 = E">
                  <button type="button" class="stats-filter-remove-btn" title="Remove filter" style="visibility: hidden;">&#10005;</button>
                </div>
              </div>
              <button type="button" id="addFilterBtn" class="stats-add-filter-btn">+ Add Filter</button>
              <div class="stats-filter-logic" id="filterLogicSection" style="display: none;">
                <label>Filter Logic:</label>
                <div class="stats-logic-options">
                  <label class="stats-logic-option">
                    <input type="radio" name="filterLogic" value="AND" checked>
                    <span>AND (all must match)</span>
                  </label>
                  <label class="stats-logic-option">
                    <input type="radio" name="filterLogic" value="OR">
                    <span>OR (any must match)</span>
                  </label>
                  <label class="stats-logic-option">
                    <input type="radio" name="filterLogic" value="custom">
                    <span>Custom</span>
                  </label>
                </div>
                <div class="stats-custom-logic" id="customLogicSection" style="display: none;">
                  <input type="text" id="customLogicInput" class="stats-field-input" placeholder="e.g., F1 AND (F2 OR F3)">
                  <p class="stats-custom-logic-hint">Use filter labels (F1, F2, etc.) with AND, OR, and parentheses</p>
                </div>
              </div>
            </div>
            <div class="stats-input-group">
              <label for="statsFieldInput">Field to Analyze:</label>
              <input type="text" id="statsFieldInput" class="stats-field-input" placeholder="e.g., FT1.13, PID.5, MSH.9.1">
            </div>
            <button id="statsGenerateBtn" class="stats-generate-btn">Evaluate</button>
          </div>
        </div>
        <div id="statsResults" class="stats-results">
          <div class="stats-no-content">
            <p>Add filters and/or a field to analyze, then click "Evaluate"</p>
            <p class="stats-hint">Field examples: PID.5 (Patient Name), FT1.13 (Description), MSH.9.1 (Message Type)</p>
            <p class="stats-hint">Filter examples: PV1.2 = E (equals), PV1.2 != I (not equals), PV1.3 contains ER (contains)</p>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-footer">
      <p class="footer-disclaimer">This application is for entertainment purposes only. There is no guarantee of accuracy or website security. Don't sue me pretty please.</p>
    </footer>
  </div>

  <!-- Download Local Application Modal -->
  <div class="modal-overlay" id="downloadModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Download Local Application</h2>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-notice">
          <p>If you intend to use this application with Protected Health Information (PHI), you should only run it locally on your own machine. Running locally ensures that no data leaves your device.</p>
        </div>
        <div class="modal-disclaimer">
          <strong>Disclaimer:</strong> Never enter PHI into any application you do not fully understand. Before using any tool with sensitive data, verify how it processes, stores, and transmits information. This application runs entirely in your browser with no server-side data processing, but you are responsible for confirming that yourself.
        </div>
        <section class="modal-section">
          <h3>1. Clone the Repository</h3>
          <p>Open a terminal and run:</p>
          <div class="code-block">
            <code>git clone https://github.com/zachromers/HL7Viewer.git</code>
            <button class="copy-code-btn" data-copy="git clone https://github.com/zachromers/HL7Viewer.git" title="Copy to clipboard">&#128203;</button>
          </div>
          <p>Or <a href="https://github.com/zachromers/HL7Viewer/archive/refs/heads/master.zip" target="_blank" rel="noopener">download the ZIP</a> directly from GitHub and extract it.</p>
        </section>

        <section class="modal-section">
          <h3>2. Open in Chrome</h3>
          <p>Navigate to the cloned folder and open the file:</p>
          <div class="code-block">
            <code>HL7Viewer/public/index.html</code>
          </div>
          <p>Right-click the file and choose <strong>Open with &rarr; Google Chrome</strong>, or drag it into an open Chrome window.</p>
        </section>

        <section class="modal-section">
          <h3>3. Create a Desktop Shortcut</h3>
          <ol>
            <li>Right-click on <code>index.html</code> in the <code>public</code> folder.</li>
            <li>Select <strong>Send to &rarr; Desktop (create shortcut)</strong>.</li>
            <li>Optionally, rename the shortcut to <strong>HL7 Viewer</strong>.</li>
          </ol>
        </section>

        <section class="modal-section">
          <h3>4. Add a Chrome Bookmark</h3>
          <ol>
            <li>Open <code>index.html</code> in Chrome.</li>
            <li>Press <kbd>Ctrl</kbd>+<kbd>D</kbd> (or <kbd>Cmd</kbd>+<kbd>D</kbd> on Mac).</li>
            <li>Name the bookmark <strong>HL7 Viewer</strong> and choose a folder.</li>
            <li>Click <strong>Done</strong>.</li>
          </ol>
        </section>
      </div>
    </div>
  </div>

  <script src="js/hl7-fields.js"></script>
  <script src="js/hl7-parser.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
